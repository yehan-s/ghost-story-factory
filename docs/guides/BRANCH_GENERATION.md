# 支线故事生成指南

## 概述

Ghost Story Factory v3.1 现在支持**自动生成支线故事**！除了主线故事，系统可以自动生成两条与主线关联的支线故事：

- **支线1 (Branch 1)**: 店主线 (The Shopkeeper) - 从四楼玉器店主的视角体验灵异事件
- **支线2 (Branch 2)**: 顾客线 (The Customer) - 从被困顾客的视角侧面烘托主线危机

## 为什么需要支线？

支线故事不是简单的"额外内容"，而是精心设计的**多视角叙事系统**：

### 1. 🎭 多视角体验
- **主线**：保安/核心角色，直接面对核心事件
- **支线1**：店主视角，通过监控"目击"主线事件
- **支线2**：顾客视角，从B3听到"警告"信息

### 2. 🔗 主线关联点
每条支线都有**明确的主线关联点**：
- 支线1在 4:44 AM 通过监控实时目击主线高潮事件
- 支线2在B3遇到"白衣女子"，她的警告反映主线的行动

### 3. 🌿 独立完整性
每条支线都是独立完整的故事：
- 有自己的场景流程
- 有自己的角色目标
- 有自己的高潮和结局
- 可以单独阅读和理解

### 4. 🎮 游戏化设计
支线为游戏引擎提供：
- 不同的访问权限（Agency）设计
- 不同的"共鸣度"路径
- 多样化的后果树和结局

## 如何生成支线

### 方法1: 使用 Python 脚本（推荐）

```bash
# 默认：生成主线 + 支线1 + 支线2
python generate_full_story.py --city 武汉

# 只生成主线，不生成支线
python generate_full_story.py --city 武汉 --no-branches

# 指定输出目录
python generate_full_story.py --city 广州 --output deliverables/程序-广州/
```

### 方法2: 使用 Shell 脚本

```bash
chmod +x generate_full_story.sh
./generate_full_story.sh 武汉
```

> ⚠️ **注意**：Shell 脚本默认会生成支线。如需跳过，请手动修改脚本或使用 Python 命令。

## 生成流程

完整的生成流程包含 4 个阶段：

```
阶段0: 收集原始素材
  └─ 武汉_raw_materials.md

阶段1: 世界书1.0
  └─ 武汉_lore_v1.md

阶段2: 角色分析 + 世界书2.0
  ├─ 武汉_protagonist.md
  └─ 武汉_lore_v2.md

阶段3: GDD + 主线故事
  ├─ 武汉_gdd.md
  └─ 武汉_story.md ⭐

阶段4: 支线故事（新增！）🌿
  ├─ 武汉_branch_1_gdd.md
  ├─ 武汉_branch_1_story.md ⭐
  ├─ 武汉_branch_2_gdd.md
  └─ 武汉_branch_2_story.md ⭐
```

## 生成文件说明

### 主线文件
| 文件 | 说明 | 用途 |
|------|------|------|
| `{城市}_gdd.md` | 主线AI导演任务简报 | 游戏引擎使用 🎮 |
| `{城市}_story.md` | 主线故事文案 | 直接阅读/配音 ⭐ |

### 支线文件
| 文件 | 说明 | 用途 |
|------|------|------|
| `{城市}_branch_1_gdd.md` | 支线1 GDD（店主线） | 游戏引擎使用 🎮 |
| `{城市}_branch_1_story.md` | 支线1故事文案 | 直接阅读/配音 ⭐ |
| `{城市}_branch_2_gdd.md` | 支线2 GDD（顾客线） | 游戏引擎使用 🎮 |
| `{城市}_branch_2_story.md` | 支线2故事文案 | 直接阅读/配音 ⭐ |

## 支线设计模式

### 支线1: 店主线 (The Shopkeeper)

**角色设定**：四楼玉器店店主

**核心目标**：
1. 调查店铺"破财"的真相
2. 在"诅咒"中保住性命或证据
3. （潜在）目击"主线"的侧面

**访问权（Agency）**：受限。锚定在 [四楼] 店铺及周边

**关键场景**：
- 场景1: 盘点（23:00-01:00）- 建立"破财"和"玉器冰冷"的氛围
- 场景2: 邻居（01:00-04:43）- 引入"四楼算盘声"异象
- 场景3: **4:44的目击**（主线关联点）- 通过监控实时目击主线高潮
- 场景4: 入侵与抉择（04:50）- "清洁工"从主线转移威胁到支线

**后果树**：
- 选项A（躲藏/装死/求饶）→ 结局A: 破财（钱变泥土）
- 选项B（反抗/抢证据/逃跑）→ 结局B: 真相（硬盘清空）

### 支线2: 顾客线 (The Customer)

**角色设定**：迷路的顾客

**核心目标**：逃离商场

**访问权（Agency）**：最低。仅限公共区域（二楼、电梯、一楼出口）

**关键场景**：
- 场景1: 被困（00:30）- 建立"无信号"的绝望感
- 场景2: 唯一的"出路"（00:40）- 强制玩家使用"北角货梯"
- 场景3: **B3的警告**（主线关联点）- 遇到"白衣女子"，她的警告反映主线行动
- 场景4: 入侵与抉择（00:55）- 听到"清洁工"追猎的脚步声

**后果树**：
- 选项A（相信她，自己逃离）→ 结局A: 幸存者（手机时间停止）
- 选项B（试图交互）→ 结局B: 同化（成为怨灵）

## 技术细节

### 支线生成的模板文件

系统使用以下模板文件来生成支线：

```
templates/
  ├── branch-1.design.md      # 支线1设计文档
  ├── branch-1.example.md     # 支线1示例故事
  ├── branch-1.prompt.md      # 支线1生成提示词
  ├── branch-2.design.md      # 支线2设计文档
  ├── branch-2.example.md     # 支线2示例故事
  └── branch-2.propmt.md      # 支线2生成提示词（注意拼写）
```

> ⚠️ **注意**：`branch-2.propmt.md` 的文件名有拼写错误（propmt而非prompt），但这是有意保留的，代码会正确处理。

### 代码实现位置

支线生成的代码位于 `generate_full_story.py`：

```python
# 阶段4: 支线故事生成
def generate_branch(self, branch_num: int, lore_v2: str, main_gdd: str):
    """生成支线故事"""
    ...

def generate_branch_story(self, branch_num: int, branch_gdd: str, lore_v2: str):
    """生成支线故事文案"""
    ...

# 主流程
def generate_all(self, include_branches: bool = True):
    """执行完整的生成流程"""
    ...
    if include_branches:
        branch1_story = self.generate_branch(1, lore_v2, gdd)
        branch2_story = self.generate_branch(2, lore_v2, gdd)
    ...
```

## 常见问题

### Q: 支线生成需要额外时间吗？
A: 是的。支线生成会增加约 40-60% 的总生成时间（每条支线约需 3-5 分钟）。

### Q: 可以只生成某一条支线吗？
A: 目前不支持。要么生成全部支线，要么不生成。如有需要，可以手动修改代码。

### Q: 支线是否可以用于游戏引擎？
A: 是的！支线的 GDD 文件完全兼容游戏引擎，可以创建多角色体验。

### Q: 杭州的例子为什么没有支线？
A: 杭州是在支线功能添加之前生成的。重新运行生成命令即可获得支线。

### Q: 支线与主线的关联是如何实现的？
A: 通过以下机制：
1. 支线生成时会接收 `main_gdd` 作为输入
2. 支线的提示词明确要求设计"主线关联点"
3. 例如：支线1在 4:44 通过监控目击主线事件
4. 例如：支线2的"白衣女子"警告内容反映主线行动

## 最佳实践

### 1. 先生成主线，再生成支线
虽然系统会自动按顺序生成，但理解上应该先读主线，再读支线。

### 2. 支线适合多人游戏场景
如果要做多人游戏，可以：
- 玩家A体验主线（保安）
- 玩家B体验支线1（店主）
- 玩家C体验支线2（顾客）
- 三条线在特定时刻（如4:44）产生交集

### 3. 支线可以独立发布
每条支线都是完整故事，可以：
- 单独配音发布
- 作为"番外篇"
- 用于"多视角剧集"系列

### 4. 跳过支线以节省时间
如果只是想快速测试主线，使用 `--no-branches` 参数。

## 下一步

- 📖 阅读 [WORKFLOW.md](./WORKFLOW.md) 了解完整工作流程
- 🎮 阅读 [GAME_ENGINE.md](../architecture/GAME_ENGINE.md) 了解如何使用支线运行游戏
- 📂 查看 [examples/](../../examples/) 文件夹中的示例输出

---

**更新日期**: 2025-10-24
**版本**: Ghost Story Factory v3.1

