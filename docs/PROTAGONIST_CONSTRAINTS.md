# 主角强约束机制

**版本**: v1.2
**最后更新**: 2025-10-24

> **v1.2 更新**：改用正向约束（必须用指定的），而非负向约束（禁止用某些）

---

## 🎯 问题背景

在之前的生成过程中，AI 有时会错误地使用 templates 中的示例角色（如"保安"、"店主"等）和地点（如"荔湾广场"），而不是基于当前城市和主角分析生成的真实主角和场景。

**典型问题**：
- 杭州的主角应该是"特检院工程师"，但生成时使用了"保安"
- GDD 项目代号应该是"北高峰缆车·特检院工程师线"，却显示为"荔湾广场·保安线"

---

## ✅ 解决方案：三层约束机制

### 1️⃣ 代码层约束（主角自动识别）

在 `gen_gdd`、`gen_main_thread` 和 `gen_complete` 函数中，添加了主角信息提取逻辑：

```python
# 从 protagonist 中提取主角信息（强约束）
protagonist_name = "未知主角"
protagonist_role = "未知身份"

import re
if protagonist_content:
    # 查找"无可争议的主角线"
    main_match = re.search(r'无可争议的主角线[：:]\s*([^\n，,。]+)', protagonist_content)
    if main_match:
        protagonist_role = main_match.group(1).strip()

    # 查找主角姓名
    name_match = re.search(r'主角姓名[：:]\s*([^\n，,。]+)', protagonist_content)
    if name_match:
        protagonist_name = name_match.group(1).strip()
```

**功能**：
- 自动从 `protagonist.md` 中提取主角角色和姓名
- 支持中英文冒号
- 支持多种表述方式（"主角姓名"、"姓名"等）

---

### 2️⃣ Prompt 层约束（强制指令）

在每个生成任务的 prompt 中，动态注入强约束块：

```markdown
[⚠️ 强制约束 - 必须遵守]
**本次任务的指定主角**：特检院工程师
**主角姓名**：顾栖迟

✅ 必须严格遵守：
1. **主角身份**：必须使用上述指定的主角 "特检院工程师"
   - 这是从【输入 2: 角色分析】中识别出的主角
   - 不得使用角色分析中未明确指定为主角的其他角色

2. **世界观来源**：必须使用【输入 1: 世界书 2.0】中定义的内容
   - 地点、规则、异象等必须来自世界书
   - 基于该主角的职业特点、访问权限、交集点设计剧情

3. **原创性要求**：
   - templates 仅作为结构、风格、系统设计的参考
   - 不得复制 templates 中的具体情节、对话、场景描述
   - 必须基于当前输入进行原创创作
```

**特点**：
- **正向约束**：明确"必须使用指定的主角"，而非"禁止使用某些角色"
- **来源明确**：强调从"角色分析"和"世界书"中获取内容
- **三层要求**：主角身份、世界观来源、原创性要求
- **避免误伤**：不会因为职业或地点巧合重复而触发约束

---

### 3️⃣ 用户反馈层（可视化提示）

在生成过程中，显示识别出的主角信息：

```bash
🎯 已识别主角：特检院工程师 (顾栖迟)
⚠️  生成过程将强制使用此主角，而非templates中的保安或其他角色
```

**作用**：
- 让用户确认主角识别是否正确
- 增强生成过程的透明度
- 方便调试和验证

---

## 🔧 实现位置

### 修改的函数

1. **`gen_gdd()`** - 生成 GDD
   - 位置：`src/ghost_story_factory/main.py` (约 1037-1078 行)
   - 功能：从 protagonist.md 提取主角，注入约束

2. **`gen_main_thread()`** - 生成主线故事
   - 位置：`src/ghost_story_factory/main.py` (约 1139-1184 行)
   - 功能：从 GDD 提取主角，注入约束

3. **`gen_complete()`** - 自动化流程
   - GDD 生成部分：`src/ghost_story_factory/main.py` (约 1430-1476 行)
   - 主线故事生成部分：`src/ghost_story_factory/main.py` (约 1504-1546 行)
   - 功能：在自动化流程中应用约束

---

## 📊 约束机制工作流

### GDD 生成流程

```
1. 读取 protagonist.md
2. 正则提取主角角色和姓名
3. 构建约束 prompt
4. 显示识别结果（用户确认）
5. 将约束注入到 prompt
6. 调用 LLM 生成 GDD
```

### 主线故事生成流程

```
1. 读取 GDD.md
2. 正则提取主角信息（从GDD中）
3. 构建约束 prompt
4. 显示识别结果（用户确认）
5. 将约束注入到 prompt
6. 调用 LLM 生成故事
```

---

## 🎨 约束提取规则

### 从 Protagonist.md 提取

| 关键词模式 | 提取内容 | 示例 |
|-----------|---------|------|
| `无可争议的主角线[：:]` | 主角职业/身份 | 特检院工程师 |
| `主角姓名[：:]` | 主角姓名 | 顾栖迟 |
| `姓名[：:]` | 主角姓名（备选） | 顾栖迟 |

### 从 GDD.md 提取

| 关键词模式 | 提取内容 | 示例 |
|-----------|---------|------|
| `主角[：:]` | 主角职业/身份 | 特检院工程师 |
| `姓名[：:]` | 主角姓名 | 顾栖迟 |
| `项目代号[：:][^\n]*?[·•]` | 主角线名称（备选） | 北高峰缆车·特检院工程师线 |

---

## 🧪 测试验证

### 手动测试步骤

1. **生成主角分析**：
   ```bash
   gen-protagonist --city "杭州"
   ```
   检查生成的 `杭州_protagonist.md` 是否包含"无可争议的主角线"标记。

2. **生成 GDD**：
   ```bash
   gen-gdd --city "杭州"
   ```
   观察输出：
   - 应显示识别出的主角
   - 检查生成的 `杭州_GDD.md` 是否使用了正确的主角

3. **生成主线故事**：
   ```bash
   gen-main-thread --city "杭州"
   ```
   观察输出：
   - 应显示从 GDD 提取的主角
   - 检查生成的 `杭州_main_thread.md` 是否使用了正确的主角

4. **自动化流程**：
   ```bash
   gen-complete --city "深圳" --index 1
   ```
   观察每个步骤的主角识别输出。

---

## 🔍 问题排查

### 主角识别失败

**症状**：显示"未知主角"或"未知身份"

**可能原因**：
1. `protagonist.md` 格式不标准
2. 没有"无可争议的主角线"标记
3. 使用了全角/半角混合的冒号

**解决方法**：
1. 检查 `protagonist.md` 格式
2. 确保包含"无可争议的主角线：XXX"这样的标记
3. 统一使用中文冒号 `：` 或英文冒号 `:`

---

### 仍然使用错误主角

**症状**：约束生效，但 AI 仍使用了 templates 角色

**可能原因**：
1. LLM 遵循指令能力不足
2. Prompt 冲突（templates 示例权重过高）
3. Context 窗口过长，约束被忽略

**解决方法**：
1. 增强 prompt 中的约束语气（已实现）
2. 在 templates 提示词中进一步强调"仅作风格参考"
3. 考虑使用更强的模型（如 GPT-4）

---

## 📝 未来优化方向

### 短期（v1.1）
- [ ] 添加主角验证机制：生成后检查输出是否包含错误角色名
- [ ] 支持更多主角标记格式（如"推荐主角"、"首选主角"等）
- [ ] 增加主角信息缓存，避免重复提取

### 中期（v1.2）
- [ ] 实现主角信息结构化存储（JSON 格式）
- [ ] 添加主角一致性检查工具
- [ ] 支持多主角并行故事线（选择主角）

### 长期（v2.0）
- [ ] AI 辅助主角识别和推荐
- [ ] 主角信息自动修正机制
- [ ] 主角-场景-剧情一致性验证

---

## 📚 相关文档

- [WORKFLOW.md](guides/WORKFLOW.md) - 完整工作流程
- [USAGE.md](guides/USAGE.md) - 命令使用说明
- [GDD.prompt.md](../templates/GDD.prompt.md) - GDD 生成模板
- [main-thread.prompt.md](../templates/main-thread.prompt.md) - 主线故事模板

---

## 💡 最佳实践

1. **始终检查 protagonist.md**：确保"无可争议的主角线"标记清晰
2. **关注识别输出**：如果识别错误，先修正 protagonist.md 再继续
3. **验证生成结果**：检查 GDD 和主线故事的项目代号、主角姓名等关键信息
4. **保持格式一致**：使用统一的标记格式（冒号、空格等）

---

## 📅 版本历史

### v1.2 (2025-10-24) - 正向约束 ⭐ 当前版本
**核心改进**：
- ✅ 改用正向约束："必须使用指定的主角"
- ✅ 去除负向约束："禁止使用某些角色/地点"
- ✅ 三层要求：主角身份、世界观来源、原创性

**解决的问题**：
- ❌ 之前：禁止"使用 templates 中的角色/地点"
  - 问题：其他城市可能恰好也有"保安"职业或同名地点
  - 问题：会误伤合理的职业和地点选择
- ✅ 现在：强调"必须使用角色分析中指定的主角"
  - 正向约束，明确来源
  - 不会因为职业/地点巧合重复而出错

**设计理念**：
- 约束的目标：确保使用"指定输入"中的内容
- 而非：排除"某些禁止列表"中的内容

### v1.1 (2025-10-24) - 去除硬编码
**改进**：
- ✅ 去除硬编码的角色名（"保安"、"店主"、"顾客"等）
- ✅ 使用泛化规则："任何 templates 中的角色/地点"
- ❌ 问题：负向约束逻辑存在缺陷（已在 v1.2 修复）

### v1.0 (2025-10-24) - 初始实现
**功能**：
- ✅ 自动从 protagonist.md 提取主角信息
- ✅ 动态注入约束到 prompt
- ✅ 用户反馈层显示识别结果
- ❌ 问题：硬编码了具体角色名（已在 v1.1 修复）

---

**维护者**: @yehan
**问题反馈**: 如果发现主角识别或约束机制的问题，请提交 issue 并附上：
1. 使用的命令
2. `protagonist.md` 的相关片段
3. 实际识别结果
4. 期望结果

