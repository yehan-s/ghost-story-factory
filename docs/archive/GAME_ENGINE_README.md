# 🎮 Ghost Story Factory - 交互式游戏引擎

> **新功能！** 现在不仅能生成故事，还能直接游玩！

---

## 🌟 快速开始

### 3 步开始游戏

```bash
# 1. 安装依赖（首次使用）
python3 -m venv venv && source venv/bin/activate
pip install -e .

# 2. 生成故事资源
gen-complete --city "杭州" --index 1

# 3. 开始游戏！
ghost-story-play 杭州
```

---

## 🎯 特性

### ✅ 已实现（P0 + P1）

- **🎮 完整的游戏循环**: 选择 → 响应 → 状态更新 → 下一个选择
- **📊 状态管理**: PR（共鸣度）、GR（全局共鸣度）、WF（世界疲劳值）
- **🎭 3 种选择类型**: 微选择、普通选择、关键选择
- **📝 AI 生成响应**: 4 层叙事结构（物理/感官/心理/引导）
- **🎨 美化界面**: Rich 库支持，进度条、彩色高亮、Markdown 渲染
- **🏆 5 个结局**: 补完、旁观、迷失、超时、献祭（隐藏）
- **💾 保存/读档**: 随时保存游戏进度
- **🎯 意图映射**: 验证选项、提取意图、风险评估

### 🚧 计划中（P2）

- Web UI（FastAPI + React）
- 实体 AI 系统（等级 0-4 行为）
- 动态气象系统
- 多人模式

---

## 📖 游戏界面预览

```
╔══════════════════════════════════════════════════════════════════╗
║                    🎭 杭州·灵异故事                              ║
║                  交互式恐怖游戏体验                              ║
╚══════════════════════════════════════════════════════════════════╝

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 个人共鸣度 [████████░░░░░░░░░░] 45/100
🌍 全局共鸣度 [████████████░░░░░░] 63/100
⏱️  世界疲劳值 [█░░░░░░░░░] 1/10

⏰ 时间: 02:30  |  📍 场景: S4
🎒 道具: 手电筒, 对讲机
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

你在五楼中庭听到...拍皮球的声音。
'啪嗒...啪嗒...啪嗒...'

但这栋楼里，除了你，不应该有其他人。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【抉择点】请选择你的行动：

  1. 💼 走过去检查声音来源 [调查, 主动]
     └─ 后果：PR +15 | 消耗时间

  2. 💼 返回中控室查看监控 [保守, 安全]
     └─ 后果：PR +5 | 消耗时间

  3. 💼 先巡逻其他楼层，稍后再来
     └─ 后果：消耗时间

  4. 💾 保存进度
  5. 🚪 退出游戏

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

请输入选项编号 [1-5]: _
```

---

## 📚 文档

- **[使用指南](GAME_ENGINE_USAGE.md)** - 详细的使用说明和 API 文档
- **[安装指南](INSTALLATION.md)** - 安装步骤和故障排除
- **[实现总结](IMPLEMENTATION_SUMMARY.md)** - 技术实现细节
- **[规格文档](docs/specs/SPEC_TODO.md)** - 完整的功能规格

---

## 🛠️ 技术栈

### 核心
- Python 3.10+
- CrewAI (AI Agent 编排)
- LiteLLM (多模型支持)

### 游戏引擎
- Pydantic (数据验证)
- Rich (CLI 美化)

### AI 模型
- Kimi/Moonshot (推荐)
- OpenAI (备选)

---

## 🎯 使用场景

### 场景 1: 快速游玩

```bash
# 使用已有的故事资源
ghost-story-play 杭州
```

### 场景 2: 生成新故事并游玩

```bash
# 1. 生成故事
gen-complete --city "武汉" --index 1

# 2. 开始游戏
ghost-story-play 武汉
```

### 场景 3: 从存档继续

```bash
# 游戏会自动创建 saves/ 目录
# 在游戏中选择"保存进度"
# 下次运行时会提示是否加载存档
```

### 场景 4: 自定义资源路径

```bash
ghost-story-play 杭州 \
  --gdd custom/path/gdd.md \
  --lore custom/path/lore.md
```

---

## 🏗️ 架构

```
GameEngine (游戏主循环)
    ├── GameState (状态管理)
    ├── ChoicePointsGenerator (选择点生成)
    │   └── LLM (AI 生成)
    ├── RuntimeResponseGenerator (响应生成)
    │   └── LLM (AI 生成)
    ├── IntentMappingEngine (意图映射)
    ├── EndingSystem (结局系统)
    └── GameCLI (用户界面)
        └── Rich (美化)
```

---

## 💡 设计理念

### 选项式交互
- 玩家从 2-4 个选项中选择
- 每个选项有明确的后果
- 避免"伪选择"和"陷阱选项"

### 四重笼子设计
1. 选项数量限制（2-4 个）
2. 物理边界限制（角色能力范围内）
3. 后果透明度（玩家可预判）
4. 强制抉择点（无法跳过）

### 失败也是内容
- 没有 Game Over
- "错误"选择导向新分支
- 每个选择都有意义

---

## 🎮 游戏机制

### 共鸣度系统
- **PR (Personal Resonance)**: 0-100，个人与灵异世界的连接
- **GR (Global Resonance)**: 0-100，全局状态（未来支持多人）
- **WF (World Fatigue)**: 0-10，世界的损耗程度

### 选择点类型
- **MICRO**: 日常互动，低风险（对话、观察）
- **NORMAL**: 情节推进（调查、移动）
- **CRITICAL**: 结局分支（关键决策）

### 结局系统
- **补完**: 持有失魂核心 + 播放录音
- **旁观**: 无核心 + 播放录音
- **迷失**: PR 达到 100%
- **超时**: 游戏时间超过 06:00
- **献祭**: 隐藏结局（需要特殊选择）

---

## 🔧 开发者指南

### 扩展游戏

```python
# 1. 自定义结局
from ghost_story_factory.engine import EndingSystem, Ending, EndingCondition

system = EndingSystem()
system.register_ending(custom_ending)

# 2. 自定义选择点
from ghost_story_factory.engine import Choice, ChoiceType

custom_choice = Choice(
    choice_id="custom_1",
    choice_text="自定义选项",
    choice_type=ChoiceType.NORMAL,
    consequences={"PR": "+10"}
)

# 3. 集成到现有系统
engine = GameEngine(city="杭州")
engine.run()
```

### 测试

```bash
# 运行测试
python3 tests/test_game_engine.py

# 检查 Linter
# (已通过，0 错误)
```

---

## 📊 项目状态

### 完成度

| 功能模块 | 状态 | 完成度 |
|---------|------|--------|
| 状态管理 | ✅ | 100% |
| 选择生成 | ✅ | 100% |
| 响应生成 | ✅ | 100% |
| 游戏循环 | ✅ | 100% |
| 意图映射 | ✅ | 100% |
| CLI 界面 | ✅ | 100% |
| 结局系统 | ✅ | 100% |
| 测试 | ✅ | 核心功能 |
| 文档 | ✅ | 100% |

### 代码质量
- ✅ Linter: 0 错误
- ✅ 模块化设计
- ✅ 类型注解
- ✅ 文档字符串
- ✅ 错误处理

---

## 🤝 贡献

欢迎贡献代码、报告 Bug、提出建议！

### 开发流程
1. Fork 项目
2. 创建功能分支
3. 提交代码
4. 运行测试
5. 提交 PR

---

## 📜 许可证

MIT License

---

## 🎉 鸣谢

感谢所有为这个项目做出贡献的开发者！

特别感谢：
- CrewAI 团队
- Rich 库作者
- Kimi/Moonshot AI

---

**开始你的灵异之旅！** 👻🎮✨

```bash
ghost-story-play 杭州
```

