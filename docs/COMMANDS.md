# 命令速查手册

## 📖 概述

本文档提供 Ghost Story Factory 所有命令的详细说明和使用示例。

---

## 🎮 游戏运行命令

### 预生成模式（推荐）

#### 启动游戏主菜单

```bash
./start_pregenerated_game.sh
```

**功能**：启动预生成游戏系统的主菜单

**主菜单选项**：
1. **选择故事** - 从已生成的故事库中选择并游玩
2. **生成故事** - 生成新的故事（支持断点续传）

**使用流程**：
```bash
# 1. 启动
$ ./start_pregenerated_game.sh

# 2. 首次使用：选择"生成故事"
╔══════════════════════════════════════╗
║          鬼故事工厂              ║
╚══════════════════════════════════════╝

1. 选择故事
2. 生成故事

请选择：2

# 3. 输入城市名
请输入城市名称：上海

# 4. 选择故事简介（从AI生成的3个中选择）
请选择一个故事（1-3）：1

# 5. 等待生成（2-4小时，可中断）
⚠️  [警告] 生成过程预计 2-4 小时
✅ [支持] 如果中断，下次可以从断点继续！

# 6. 生成完成后，选择"选择故事"开始游玩
```

**环境变量**（生成时需要）：
- `KIMI_API_KEY` - Kimi API 密钥
- `KIMI_API_BASE` - Kimi API 地址（可选，默认：https://api.moonshot.cn/v1）
- `KIMI_MODEL_CHOICES` - 选择生成模型（可选，默认：moonshot-v1-32k）
- `KIMI_MODEL_RESPONSE` - 响应生成模型（可选，默认：kimi-k2-0905-preview）
- `KIMI_MODEL_OPENING` - 开场生成模型（可选，默认：kimi-k2-0905-preview）

---

### 动态模式

#### 启动动态游戏（实时LLM生成）

```bash
./play_now.sh
```

或

```bash
python play_game_full.py
```

**功能**：启动动态游戏引擎，所有内容实时由LLM生成

**特性**：
- 完全动态的剧情
- 实时响应玩家选择
- 需要网络和API Key

**环境变量**（必需）：
- `KIMI_API_KEY` 或 `OPENAI_API_KEY`

---

## 🔧 辅助工具命令

### 查看生成进度

```bash
./check_progress.sh
```

**功能**：查看所有未完成的故事生成任务

**输出示例**：
```
═══════════════════════════════════════
未完成的生成任务
═══════════════════════════════════════

📍 城市：上海
   进度：1/3 个角色
   提示：重新运行时输入 '上海'

═══════════════════════════════════════
```

**使用场景**：
- 中断生成后，不记得之前输入的城市名
- 想查看当前有哪些未完成的任务
- 确认生成进度

---

## ⚙️ 环境配置

### 环境变量配置

创建 `.env` 文件：

```bash
# Kimi API 配置（推荐）
KIMI_API_KEY=your_kimi_api_key_here
KIMI_API_BASE=https://api.moonshot.cn/v1
KIMI_MODEL_CHOICES=moonshot-v1-32k
KIMI_MODEL_RESPONSE=kimi-k2-0905-preview
KIMI_MODEL_OPENING=kimi-k2-0905-preview

# 或使用 OpenAI
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_BASE_URL=https://api.openai.com/v1

# CrewAI 遥测禁用（推荐）
OTEL_SDK_DISABLED=true
```

### 模型配置说明

**分层模型策略**（预生成模式）：

| 功能 | 环境变量 | 推荐模型 | 说明 |
|------|---------|---------|------|
| 选择生成 | `KIMI_MODEL_CHOICES` | `moonshot-v1-32k` | 速度优先，生成选项 |
| 响应生成 | `KIMI_MODEL_RESPONSE` | `kimi-k2-0905-preview` | 质量优先，生成叙事 |
| 开场生成 | `KIMI_MODEL_OPENING` | `kimi-k2-0905-preview` | 质量优先，开场叙事 |

**为什么分层？**
- **选择生成**：调用频繁（每个节点），使用快速模型节省时间和成本
- **响应/开场生成**：影响叙事质量，使用高质量模型确保体验

**成本对比**（估算）：
- 全部使用 `kimi-k2-0905-preview`：6-8 小时，¥30-50
- 分层策略：2-4 小时，¥15-25（节省50%时间和成本）

---

## 📊 断点续传功能

### 工作原理

系统会在以下时机自动保存检查点：
1. **对话树级**：每生成 50 个节点
2. **角色级**：每完成一个角色的对话树

### 检查点文件位置

```
checkpoints/
├── {城市}_characters.json          # 角色级检查点
├── {城市}_{角色1}_tree.json        # 角色1的对话树检查点
└── {城市}_{角色2}_tree.json        # 角色2的对话树检查点
```

### 如何恢复生成

**步骤**：
1. 重新运行游戏：`./start_pregenerated_game.sh`
2. 选择"生成故事"
3. 输入**相同的城市名**（重要！）
4. 系统自动检测并恢复

**示例**：
```bash
# 第一次生成（中断）
$ ./start_pregenerated_game.sh
选择：2
城市：上海
# ... 生成到100个节点，按 Ctrl+C 中断

# 重新启动（恢复）
$ ./start_pregenerated_game.sh
选择：2
城市：上海  ← 必须相同
✅ 发现未完成的检查点！正在恢复...
   已恢复 100 个节点
   从节点 #101 继续生成...
```

### 检查点管理

**查看检查点**：
```bash
ls -lh checkpoints/
```

**清理检查点**（如果想重新生成）：
```bash
# 清理所有检查点
rm -rf checkpoints/

# 清理特定城市的检查点
rm -f checkpoints/上海_*.json
```

**重要**：生成成功后，系统会自动清理检查点文件！

---

## 🎯 使用场景示例

### 场景1：首次生成故事

```bash
# 1. 启动游戏
./start_pregenerated_game.sh

# 2. 选择生成
选择：2

# 3. 输入城市
城市：北京

# 4. 选择简介
请选择一个故事（1-3）：2

# 5. 确认生成
按 Enter 确认开始生成...
[Enter]

# 6. 等待完成（2-4小时）
💾 [检查点] 已保存 50 个节点...
💾 [检查点] 已保存 100 个节点...
...
✅ 故事生成完成！
```

### 场景2：中断后恢复

```bash
# 生成中断了（网络/关机/Ctrl+C）
^C

# 重新启动
./start_pregenerated_game.sh

# 选择生成，输入相同城市名
选择：2
城市：北京  ← 和之前相同

# 自动恢复
✅ 发现未完成的检查点！正在恢复...
   已恢复 100 个节点
   从节点 #101 继续生成...
```

### 场景3：游玩已生成的故事

```bash
# 1. 启动游戏
./start_pregenerated_game.sh

# 2. 选择故事
选择：1

# 3. 选择城市
请选择城市：
1. 北京
2. 上海
选择：1

# 4. 选择故事
请选择故事：
1. 废弃地铁站的午夜列车
2. 故宫角楼的幽灵守卫
选择：1

# 5. 选择角色
请选择角色：
⭐ 1. 地铁维修工（主角）
   2. 夜班保安
选择：1

# 6. 开始游玩
[游戏开始，零等待！]
```

### 场景4：查看未完成任务

```bash
# 忘记之前生成的是哪个城市
./check_progress.sh

# 输出
📍 城市：北京
   进度：1/3 个角色
   提示：重新运行时输入 '北京'

# 根据提示恢复
./start_pregenerated_game.sh
选择：2
城市：北京  ← 按提示输入
```

---

## 🚨 常见问题

### Q1: 输错城市名怎么办？

**问题**：
```
第一次：城市名：上海
第二次：城市名：shanghai  ← 输错了！
结果：没有恢复检查点，开始新的生成
```

**解决方案**：
1. 立即 `Ctrl+C` 停止
2. 重新运行，输入正确的城市名（`上海`）
3. 系统会自动恢复

**避免方法**：
```bash
# 启动前先查看
./check_progress.sh
# 看到提示后再输入
```

### Q2: 生成过程中可以关机吗？

**答案**：可以！

断点续传支持所有形式的中断：
- ✅ Ctrl+C
- ✅ 关闭终端
- ✅ 关机/休眠
- ✅ 网络断开

重新启动后，输入相同城市名即可恢复。

### Q3: 检查点会永久保留吗？

**答案**：不会。

- ✅ 生成成功 → 自动清理检查点
- ✅ 生成失败 → 保留检查点，方便恢复

### Q4: 可以同时生成多个城市吗？

**答案**：不推荐。

检查点文件按城市名保存，同时生成可能导致混乱。
建议：一个城市生成完成后，再生成下一个。

### Q5: 生成时间为什么这么久？

**答案**：因为质量保证。

生成一个完整故事需要：
- 150-200 个对话节点
- 每个节点：
  - 生成选项（3-5个）
  - 生成叙事文本（200-300字）
  - 更新游戏状态
- 总计：30,000-50,000 字的内容

**优化建议**：
```bash
# 使用分层模型策略（已默认配置）
KIMI_MODEL_CHOICES=moonshot-v1-32k        # 快速模型
KIMI_MODEL_RESPONSE=kimi-k2-0905-preview  # 高质量模型
```

### Q6: 生成失败了怎么办？

**检查**：
```bash
# 1. 查看错误信息
cat logs/generation.log  # 如果有日志

# 2. 检查API配置
cat .env | grep KIMI

# 3. 检查网络连接
curl https://api.moonshot.cn/v1/models
```

**常见原因**：
- API Key 无效或过期
- 网络连接问题
- API 限流（Kimi 504 Gateway Timeout）

**解决**：
- 检查 `.env` 配置
- 稍后重试（自动从断点继续）
- 切换到 OpenAI API

---

## 📚 相关文档

- **详细功能文档**：`docs/PREGENERATION_DESIGN.md`
- **断点续传说明**：`docs/CHECKPOINT_RESUME.md`
- **完成报告**：`docs/CHECKPOINT_FEATURE_COMPLETE.md`
- **环境配置示例**：`ENV_EXAMPLE.md`
- **优化总结**：`docs/OPTIMIZATION_SUMMARY.md`

---

## 🎯 快速命令参考

### 常用命令

| 命令 | 说明 |
|------|------|
| `./start_pregenerated_game.sh` | 启动预生成游戏主菜单 |
| `./check_progress.sh` | 查看未完成的生成任务 |
| `./play_now.sh` | 启动动态游戏（实时LLM） |

### 检查点管理

| 命令 | 说明 |
|------|------|
| `ls checkpoints/` | 查看所有检查点文件 |
| `rm -rf checkpoints/` | 清理所有检查点 |
| `rm -f checkpoints/{城市}_*.json` | 清理特定城市的检查点 |

### 数据库管理

| 命令 | 说明 |
|------|------|
| `ls database/ghost_stories.db` | 查看数据库文件 |
| `sqlite3 database/ghost_stories.db` | 打开数据库（SQLite） |

### 环境配置

| 命令 | 说明 |
|------|------|
| `cat .env` | 查看当前配置 |
| `cat ENV_EXAMPLE.md` | 查看配置示例 |

---

## 🔄 命令执行流程图

### 预生成模式完整流程

```
┌─────────────────────────────────────┐
│  ./start_pregenerated_game.sh       │
└────────────┬────────────────────────┘
             │
             ▼
      ┌──────────────┐
      │  主菜单      │
      └─┬──────────┬─┘
        │          │
   选择1│         │选择2
        │          │
        ▼          ▼
  ┌─────────┐  ┌──────────┐
  │选择故事  │  │生成故事   │
  └─────────┘  └─────┬────┘
        │            │
        │            ▼
        │      ┌──────────┐
        │      │输入城市名 │
        │      └─────┬────┘
        │            │
        │            ▼
        │      ┌──────────────┐
        │      │检查点存在？   │
        │      └─┬──────────┬─┘
        │        │          │
        │       是│         │否
        │        │          │
        │        ▼          ▼
        │   ┌─────────┐  ┌──────────┐
        │   │从断点恢  │  │生成简介   │
        │   │复生成    │  │选择简介   │
        │   └─────────┘  └─────┬────┘
        │        │            │
        │        │            ▼
        │        │      ┌──────────┐
        │        │      │开始生成   │
        │        │      └─────┬────┘
        │        │            │
        │        └────────────┤
        │                     │
        │                     ▼
        │              ┌─────────────┐
        │              │每50节点保存  │
        │              │检查点        │
        │              └─────┬───────┘
        │                    │
        │                    ▼
        │              ┌─────────────┐
        │              │生成完成      │
        │              │清理检查点    │
        │              │保存到数据库  │
        │              └──────────────┘
        │                     │
        └─────────────────────┘
                    │
                    ▼
              ┌──────────┐
              │开始游玩   │
              └──────────┘
```

---

<p align="center">
  <strong>Happy Gaming! 🎮👻</strong>
</p>

